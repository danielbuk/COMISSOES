{% extends "base.html" %}

{% block title %}Produtos Especiais - Sistema de Comiss√µes{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>üì¶ Cadastro de Produtos Especiais</h1>
        <p>Gerencie produtos que possuem taxa de comiss√£o diferente da padr√£o</p>
    </div>

    <div class="nav-tabs">
        <a href="/" class="tab">üè† Dashboard</a>
        <a href="/cadastro" class="tab">üë• Cadastro</a>
        <a href="/comissoes" class="tab">üí∞ Comiss√µes</a>
        <a href="/produtos-especiais" class="tab active">üì¶ Produtos Especiais</a>
    </div>

    <!-- Se√ß√£o de Status do Cache -->
    <div class="cache-status-section">
        <div class="cache-info">
            <h3>üìä Status do Cache de Produtos</h3>
            <div id="cacheStats" class="cache-stats">
                <div class="stat-item">
                    <span class="stat-label">Produtos em Cache:</span>
                    <span id="totalProdutos" class="stat-value">Carregando...</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">√öltima Sincroniza√ß√£o:</span>
                    <span id="ultimaSincronizacao" class="stat-value">Carregando...</span>
                </div>
            </div>
        </div>
        <div class="cache-actions">
            <button type="button" class="btn btn-primary" onclick="sincronizarProdutos()">
                üîÑ Sincronizar Produtos do Oracle
            </button>
            <small>Atualiza a lista de produtos do Oracle no cache local</small>
        </div>
    </div>

    <div class="form-section">
        <h2>‚ûï Adicionar Novo Produto Especial</h2>
        
        <form id="produtoForm" class="form">
            <!-- Campo de Sele√ß√£o Inteligente -->
            <div class="form-group">
                <label for="produtoSelector">Selecionar Produto:</label>
                <div class="smart-select-container">
                    <input type="text" id="produtoSelector" placeholder="Digite o c√≥digo ou nome do produto..." autocomplete="off">
                    <div id="produtoDropdown" class="smart-dropdown" style="display: none;"></div>
                </div>
                <small>Digite para buscar produtos no cache local</small>
            </div>
            
            <!-- Campos ocultos para os dados do produto -->
            <input type="hidden" id="codigo_produto" name="codigo_produto">
            <input type="hidden" id="nome_produto" name="nome_produto">
            
            <!-- Informa√ß√µes do produto selecionado -->
            <div id="produtoInfo" class="produto-info" style="display: none;">
                <div class="info-item">
                    <strong>C√≥digo:</strong> <span id="infoCodigo"></span>
                </div>
                <div class="info-item">
                    <strong>Nome:</strong> <span id="infoNome"></span>
                </div>
            </div>
            
            <div class="form-group">
                <label for="taxa_comissao">Taxa de Comiss√£o (%):</label>
                <input type="number" id="taxa_comissao" name="taxa_comissao" step="0.01" min="0" max="100" required>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Salvar Produto</button>
                <button type="button" class="btn btn-secondary" onclick="limparFormulario()">Limpar</button>
            </div>
        </form>
    </div>

    <div class="list-section">
        <h2>üìã Produtos Especiais Cadastrados</h2>
        <div id="produtosList" class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Nome do Produto</th>
                        <th>Taxa de Comiss√£o</th>
                        <th>Data Cadastro</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="produtosTableBody">
                    {% for produto in produtos %}
                    <tr data-id="{{ produto.id }}">
                        <td>{{ produto.codigo_produto }}</td>
                        <td>{{ produto.nome_produto }}</td>
                        <td>{{ "%.2f"|format(produto.taxa_comissao * 100) }}%</td>
                        <td>{{ produto.data_cadastro.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editarProduto({{ produto.id }})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="excluirProduto({{ produto.id }})">üóëÔ∏è</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
let editandoId = null;
let timeoutBusca = null;

// Carregar estat√≠sticas do cache ao iniciar
document.addEventListener('DOMContentLoaded', function() {
    carregarEstatisticasCache();
    carregarProdutos();
});

// Carregar estat√≠sticas do cache
function carregarEstatisticasCache() {
    fetch('/api/estatisticas-cache')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const stats = data.estatisticas;
            document.getElementById('totalProdutos').textContent = stats.total_produtos;
            
            if (stats.ultima_sincronizacao) {
                const data = new Date(stats.ultima_sincronizacao);
                document.getElementById('ultimaSincronizacao').textContent = 
                    data.toLocaleString('pt-BR');
            } else {
                document.getElementById('ultimaSincronizacao').textContent = 'Nunca';
            }
        }
    })
    .catch(error => {
        console.error('Erro ao carregar estat√≠sticas:', error);
    });
}

// Sincronizar produtos do Oracle
function sincronizarProdutos() {
    const button = document.querySelector('button[onclick="sincronizarProdutos()"]');
    button.disabled = true;
    button.textContent = 'üîÑ Sincronizando...';
    
    fetch('/api/sincronizar-produtos-oracle', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
            carregarEstatisticasCache();
        } else {
            alert('‚ùå Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('‚ùå Erro ao sincronizar produtos');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'üîÑ Sincronizar Produtos do Oracle';
    });
}

// Configurar busca inteligente
document.getElementById('produtoSelector').addEventListener('input', function(e) {
    const valor = e.target.value.trim();
    
    // Limpar timeout anterior
    if (timeoutBusca) {
        clearTimeout(timeoutBusca);
    }
    
    // Esconder dropdown se n√£o h√° valor
    if (!valor) {
        document.getElementById('produtoDropdown').style.display = 'none';
        return;
    }
    
    // Buscar ap√≥s 300ms de pausa na digita√ß√£o
    timeoutBusca = setTimeout(() => {
        buscarProdutos(valor);
    }, 300);
});

// Buscar produtos no cache
function buscarProdutos(filtro) {
    fetch(`/api/produtos-oracle-cached?filtro=${encodeURIComponent(filtro)}&limite=20`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarDropdownProdutos(data.produtos);
        } else {
            console.error('Erro ao buscar produtos:', data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
    });
}

// Mostrar dropdown com produtos
function mostrarDropdownProdutos(produtos) {
    const dropdown = document.getElementById('produtoDropdown');
    
    if (produtos.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-item no-results">Nenhum produto encontrado</div>';
    } else {
        dropdown.innerHTML = produtos.map(produto => 
            `<div class="dropdown-item" onclick="selecionarProduto('${produto.codigo}', '${produto.nome.replace(/'/g, "\\'")}')">
                <div class="produto-codigo">${produto.codigo}</div>
                <div class="produto-nome">${produto.nome}</div>
            </div>`
        ).join('');
    }
    
    dropdown.style.display = 'block';
}

// Selecionar produto do dropdown
function selecionarProduto(codigo, nome) {
    document.getElementById('produtoSelector').value = `${codigo} - ${nome}`;
    document.getElementById('codigo_produto').value = codigo;
    document.getElementById('nome_produto').value = nome;
    
    // Mostrar informa√ß√µes do produto
    document.getElementById('infoCodigo').textContent = codigo;
    document.getElementById('infoNome').textContent = nome;
    document.getElementById('produtoInfo').style.display = 'block';
    
    // Esconder dropdown
    document.getElementById('produtoDropdown').style.display = 'none';
    
    // Focar no campo de taxa
    document.getElementById('taxa_comissao').focus();
}

// Esconder dropdown quando clicar fora
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('produtoDropdown');
    const selector = document.getElementById('produtoSelector');
    
    if (!dropdown.contains(e.target) && !selector.contains(e.target)) {
        dropdown.style.display = 'none';
    }
});

// Submiss√£o do formul√°rio
document.getElementById('produtoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const codigo = document.getElementById('codigo_produto').value;
    const nome = document.getElementById('nome_produto').value;
    const taxa = document.getElementById('taxa_comissao').value;
    
    if (!codigo || !nome) {
        alert('Por favor, selecione um produto primeiro.');
        return;
    }
    
    const formData = {
        codigo_produto: codigo,
        nome_produto: nome,
        taxa_comissao: parseFloat(taxa) / 100
    };
    
    if (editandoId) {
        atualizarProduto(editandoId, formData);
    } else {
        criarProduto(formData);
    }
});

function criarProduto(data) {
    fetch('/api/produtos-especiais', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('‚úÖ Produto criado com sucesso!');
            limparFormulario();
            carregarProdutos();
        } else {
            alert('‚ùå Erro: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('‚ùå Erro ao criar produto');
    });
}

function atualizarProduto(id, data) {
    fetch(`/api/produtos-especiais/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('‚úÖ Produto atualizado com sucesso!');
            limparFormulario();
            carregarProdutos();
        } else {
            alert('‚ùå Erro: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('‚ùå Erro ao atualizar produto');
    });
}

function editarProduto(id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    const cells = row.cells;
    
    document.getElementById('produtoSelector').value = `${cells[0].textContent} - ${cells[1].textContent}`;
    document.getElementById('codigo_produto').value = cells[0].textContent;
    document.getElementById('nome_produto').value = cells[1].textContent;
    document.getElementById('taxa_comissao').value = parseFloat(cells[2].textContent.replace('%', ''));
    
    // Mostrar informa√ß√µes do produto
    document.getElementById('infoCodigo').textContent = cells[0].textContent;
    document.getElementById('infoNome').textContent = cells[1].textContent;
    document.getElementById('produtoInfo').style.display = 'block';
    
    editandoId = id;
    document.querySelector('button[type="submit"]').textContent = 'Atualizar Produto';
}

function excluirProduto(id) {
    if (confirm('Tem certeza que deseja excluir este produto?')) {
        fetch(`/api/produtos-especiais/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('‚úÖ Produto exclu√≠do com sucesso!');
                carregarProdutos();
            } else {
                alert('‚ùå Erro: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('‚ùå Erro ao excluir produto');
        });
    }
}

function limparFormulario() {
    document.getElementById('produtoForm').reset();
    document.getElementById('produtoSelector').value = '';
    document.getElementById('codigo_produto').value = '';
    document.getElementById('nome_produto').value = '';
    document.getElementById('produtoInfo').style.display = 'none';
    document.getElementById('produtoDropdown').style.display = 'none';
    editandoId = null;
    document.querySelector('button[type="submit"]').textContent = 'Salvar Produto';
}

function carregarProdutos() {
    fetch('/api/produtos-especiais')
    .then(response => response.json())
    .then(produtos => {
        const tbody = document.getElementById('produtosTableBody');
        tbody.innerHTML = '';
        
        produtos.forEach(produto => {
            const row = document.createElement('tr');
            row.setAttribute('data-id', produto.id);
            row.innerHTML = `
                <td>${produto.codigo_produto}</td>
                <td>${produto.nome_produto}</td>
                <td>${(produto.taxa_comissao * 100).toFixed(2)}%</td>
                <td>${produto.data_cadastro}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editarProduto(${produto.id})">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-danger" onclick="excluirProduto(${produto.id})">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    })
    .catch(error => {
        console.error('Erro ao carregar produtos:', error);
    });
}
</script>

<style>
.cache-status-section {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.cache-info h3 {
    margin: 0 0 15px 0;
    color: #495057;
}

.cache-stats {
    display: flex;
    gap: 30px;
}

.stat-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.stat-label {
    font-size: 0.9em;
    color: #6c757d;
    font-weight: 500;
}

.stat-value {
    font-size: 1.1em;
    font-weight: 600;
    color: #495057;
}

.cache-actions {
    text-align: right;
}

.cache-actions small {
    display: block;
    margin-top: 5px;
    color: #6c757d;
}

.smart-select-container {
    position: relative;
}

.smart-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.dropdown-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item.no-results {
    color: #6c757d;
    font-style: italic;
    cursor: default;
}

.dropdown-item:hover.no-results {
    background-color: transparent;
}

.produto-codigo {
    font-weight: 600;
    color: #495057;
    font-size: 0.9em;
}

.produto-nome {
    color: #6c757d;
    font-size: 0.85em;
    margin-top: 2px;
}

.produto-info {
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 6px;
    padding: 15px;
    margin: 15px 0;
}

.info-item {
    margin-bottom: 8px;
}

.info-item:last-child {
    margin-bottom: 0;
}

.info-item strong {
    color: #1976d2;
    margin-right: 8px;
}

@media (max-width: 768px) {
    .cache-status-section {
        flex-direction: column;
        gap: 20px;
    }
    
    .cache-actions {
        text-align: left;
    }
    
    .cache-stats {
        flex-direction: column;
        gap: 15px;
    }
}
</style>
{% endblock %}
