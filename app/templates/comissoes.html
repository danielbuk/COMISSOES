{% extends "base.html" %}

{% block title %}Cadastro de Comiss√µes - Sistema de Comiss√µes{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>üí∞ Cadastro de Comiss√µes</h1>
        <p>Gerencie comiss√µes padr√£o e regras espec√≠ficas por produto</p>
    </div>

    <div class="nav-tabs">
        <a href="/" class="tab">üè† Dashboard</a>
        <a href="/cadastro" class="tab">üë• Cadastro</a>
        <a href="/comissoes" class="tab active">üí∞ Comiss√µes</a>
        <a href="/produtos-especiais" class="tab">üì¶ Produtos Especiais</a>
    </div>

    <!-- Se√ß√£o de Comiss√µes Padr√£o -->
    <div class="card">
        <div class="card-header">
            <h2>Comiss√µes Padr√£o por Vendedor</h2>
            <p>Configure a comiss√£o padr√£o para cada vendedor (aplicada quando n√£o h√° regra espec√≠fica)</p>
        </div>
        
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>RCA</th>
                        <th>Nome</th>
                        <th>Comiss√£o Padr√£o (%)</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="comissoesPadraoTable">
                    {% for comissao in comissoes_padrao %}
                    <tr data-rca="{{ comissao.vendedor_rca }}">
                        <td>{{ comissao.vendedor_rca }}</td>
                        <td>{{ comissao.vendedor.nome }}</td>
                        <td>
                            <input type="number" 
                                   class="form-control comissao-padrao-input" 
                                   value="{{ "%.1f"|format(comissao.taxa_comissao * 100) }}"
                                   min="0" 
                                   max="100" 
                                   step="0.1"
                                   data-rca="{{ comissao.vendedor_rca }}">
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="salvarComissaoPadrao({{ comissao.vendedor_rca }})">
                                üíæ Salvar
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Se√ß√£o de Regras Espec√≠ficas -->
    <div class="card">
        <div class="card-header">
            <h2>Regras Espec√≠ficas por Produto</h2>
            <p>Configure comiss√µes espec√≠ficas para produtos (sobrescrevem a comiss√£o padr√£o)</p>
        </div>
        
        <!-- Formul√°rio para nova regra -->
        <div class="form-section">
            <h3>Nova Regra de Comiss√£o</h3>
            <form id="novaRegraForm" class="form-inline">
                <div class="form-group">
                    <label for="vendedorSelect">Vendedor:</label>
                    <select id="vendedorSelect" class="form-control">
                        <option value="">Todos os vendedores</option>
                        {% for vendedor in vendedores %}
                        <option value="{{ vendedor.rca }}">{{ vendedor.rca }} - {{ vendedor.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="codigoProduto">C√≥digo do Produto:</label>
                    <input type="text" id="codigoProduto" class="form-control" required placeholder="Ex: 123">
                </div>
                <div class="form-group">
                    <label for="taxaComissao">Comiss√£o (%):</label>
                    <input type="number" id="taxaComissao" class="form-control" required min="0" max="100" step="0.1" placeholder="Ex: 2.5">
                </div>
                <button type="submit" class="btn btn-success">‚ûï Adicionar Regra</button>
            </form>
        </div>
        
        <!-- Tabela de regras existentes -->
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Vendedor</th>
                        <th>Produto</th>
                        <th>Comiss√£o (%)</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="regrasComissaoTable">
                    {% for regra in regras_comissao %}
                    <tr data-id="{{ regra.id }}">
                        <td>{{ regra.vendedor.nome if regra.vendedor else 'Todos' }}</td>
                        <td>{{ regra.codigo_produto }}</td>
                        <td>{{ "%.1f"|format(regra.taxa_comissao * 100) }}%</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deletarRegra({{ regra.id }})">
                                üóëÔ∏è Excluir
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Informa√ß√µes sobre hierarquia -->
    <div class="card">
        <div class="card-header">
            <h2>‚ÑπÔ∏è Como Funciona a Hierarquia de Comiss√µes</h2>
        </div>
        <div class="card-body">
            <ol>
                <li><strong>Regra Espec√≠fica (Vendedor + Produto):</strong> Maior prioridade - aplica-se apenas ao vendedor espec√≠fico para o produto espec√≠fico</li>
                <li><strong>Regra por Produto:</strong> Aplica-se a todos os vendedores para o produto espec√≠fico</li>
                <li><strong>Comiss√£o Padr√£o:</strong> Aplica-se quando n√£o h√° regras espec√≠ficas para o produto</li>
            </ol>
            <p><strong>Exemplo:</strong> Se o PRODUTO 123 tem comiss√£o espec√≠fica de 3%, ele aparecer√° na lista. Se n√£o tiver, aparecer√° como "OUTROS PRODUTOS" com a comiss√£o padr√£o.</p>
        </div>
    </div>
</div>

<script>
// Salvar comiss√£o padr√£o
function salvarComissaoPadrao(rca) {
    const input = document.querySelector(`input[data-rca="${rca}"]`);
    const taxa = parseFloat(input.value) / 100; // Converte de % para decimal
    
    fetch(`/api/comissoes-padrao/${rca}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            taxa_comissao: taxa
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Comiss√£o padr√£o atualizada com sucesso!', 'success');
        } else {
            showMessage('Erro ao atualizar: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Erro ao atualizar: ' + error, 'error');
    });
}

// Formul√°rio para nova regra
document.getElementById('novaRegraForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const vendedorRca = document.getElementById('vendedorSelect').value;
    const codigoProduto = document.getElementById('codigoProduto').value;
    const taxaComissao = parseFloat(document.getElementById('taxaComissao').value) / 100;
    
    fetch('/api/regras-comissao', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            vendedor_rca: vendedorRca || null,
            codigo_produto: codigoProduto,
            taxa_comissao: taxaComissao
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Regra de comiss√£o criada com sucesso!', 'success');
            // Limpa o formul√°rio
            document.getElementById('vendedorSelect').value = '';
            document.getElementById('codigoProduto').value = '';
            document.getElementById('taxaComissao').value = '';
            // Recarrega a p√°gina para mostrar a nova regra
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Erro ao criar: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Erro ao criar: ' + error, 'error');
    });
});

// Deletar regra
function deletarRegra(regraId) {
    if (!confirm('Tem certeza que deseja excluir esta regra?')) {
        return;
    }
    
    fetch(`/api/regras-comissao/${regraId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Regra de comiss√£o deletada com sucesso!', 'success');
            // Remove a linha da tabela
            document.querySelector(`tr[data-id="${regraId}"]`).remove();
        } else {
            showMessage('Erro ao deletar: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showMessage('Erro ao deletar: ' + error, 'error');
    });
}

// Auto-save para comiss√µes padr√£o
document.querySelectorAll('.comissao-padrao-input').forEach(input => {
    let timeout;
    input.addEventListener('input', function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            const rca = this.dataset.rca;
            salvarComissaoPadrao(rca);
        }, 1000); // Salva automaticamente ap√≥s 1 segundo sem digita√ß√£o
    });
});

function showMessage(message, type) {
    // Implementar sistema de mensagens
    alert(message);
}
</script>

<style>
.form-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.form-inline {
    display: flex;
    gap: 15px;
    align-items: end;
    flex-wrap: wrap;
}

.form-inline .form-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
}

.form-inline label {
    margin-bottom: 5px;
    font-weight: 500;
}

.comissao-padrao-input {
    width: 80px;
    text-align: center;
}

.card-body ol {
    margin: 0;
    padding-left: 20px;
}

.card-body li {
    margin-bottom: 10px;
}
</style>
{% endblock %}
