{% extends "base.html" %}

{% block title %}Relat√≥rio de Comiss√µes - Sistema de Comiss√µes{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>üìä Relat√≥rio de Comiss√µes</h1>
        <p>{{ message }}</p>
        <div class="period-info">
            <span class="badge badge-primary">{{ mes }}/{{ ano }}</span>
        </div>
    </div>

    <div class="nav-tabs">
        <a href="/" class="tab">üè† Dashboard</a>
        <a href="/cadastro" class="tab">üë• Cadastro</a>
        <a href="/comissoes" class="tab">üí∞ Comiss√µes</a>
        <a href="/produtos-especiais" class="tab">üì¶ Produtos Especiais</a>
        <a href="/relatorio?mes={{ mes }}&ano={{ ano }}" class="tab active">üìä Relat√≥rio</a>
    </div>

    {% if sellers %}
        <div class="report-summary">
            <div class="summary-card">
                <h3>Resumo Geral</h3>
                <div class="summary-stats">
                    <div class="stat">
                        <span class="stat-label">Total de Vendedores:</span>
                        <span class="stat-value">{{ sellers|length }}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Faturamento Total:</span>
                        <span class="stat-value">R$ {{ "{:,.2f}".format(sellers.values()|sum(attribute='faturamentoFinal')) }}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Comiss√µes Base:</span>
                        <span class="stat-value">R$ {{ "{:,.2f}".format(sellers.values()|sum(attribute='totalCommission')) }}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Comiss√µes Finais:</span>
                        <span class="stat-value">R$ {{ "{:,.2f}".format(sellers.values()|sum(attribute='comissaoFinal')) }}</span>
                    </div>
                </div>
                <div class="pdf-download-section">
                    <a href="{{ url_for('gerar_pdf_relatorio', mes=mes, ano=ano) }}" class="btn btn-primary pdf-download-btn">
                        üìÑ Baixar PDF
                    </a>
                </div>
            </div>
        </div>

        {% for seller_code, seller in sellers.items() %}
        <div class="seller-card {% if seller.is_cooperativa %}cooperativa{% endif %}">
            <div class="seller-header">
                <h2>{{ seller.name }}</h2>
                <div class="seller-info">
                    <span class="badge badge-{{ 'primary' if seller.type == 'Interno' else 'secondary' }}">{{ seller.type }}</span>
                    <span class="badge badge-info">RCA: {{ seller_code }}</span>
                    {% if seller.is_cooperativa %}
                        <span class="badge badge-danger">Cooperativa</span>
                    {% endif %}
                    <button class="btn btn-sm btn-outline-primary ajuste-btn" 
                            data-rca="{{ seller_code }}" 
                            data-nome="{{ seller.name }}" 
                            data-mes="{{ mes }}" 
                            data-ano="{{ ano }}">
                        ‚úèÔ∏è Ajustes Financeiros
                    </button>
                    <button class="btn btn-sm btn-outline-success ajuste-faturamento-btn" 
                            data-rca="{{ seller_code }}" 
                            data-nome="{{ seller.name }}" 
                            data-mes="{{ mes }}" 
                            data-ano="{{ ano }}">
                        üìà Ajuste de Faturamento
                    </button>
                </div>
            </div>

            <div class="seller-summary">
                <div class="summary-row">
                    <div class="summary-item">
                        <span class="label">Faturamento Oracle:</span>
                        <span class="value">R$ {{ "{:,.2f}".format(seller.faturamentoOracle) }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Faturamento Final:</span>
                        <span class="value">R$ {{ "{:,.2f}".format(seller.faturamentoFinal) }}</span>
                    </div>
                </div>
                
                {% if seller.ajusteFaturamento.valorAjuste != 0 %}
                <div class="summary-row ajuste-row">
                    <div class="summary-item">
                        <span class="label">Ajuste Manual:</span>
                        <span class="value {% if seller.ajusteFaturamento.valorAjuste > 0 %}positive{% else %}negative{% endif %}">
                            {% if seller.ajusteFaturamento.valorAjuste > 0 %}+{% endif %}R$ {{ "{:,.2f}".format(seller.ajusteFaturamento.valorAjuste) }}
                            <small>({{ "{:.1%}".format(seller.ajusteFaturamento.taxaComissaoAjuste) }})</small>
                        </span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Comiss√£o do Ajuste:</span>
                        <span class="value">R$ {{ "{:,.2f}".format(seller.comissaoDoAjuste) }}</span>
                    </div>
                </div>
                {% endif %}
                
                <div class="summary-row">
                    <div class="summary-item">
                        <span class="label">Comiss√£o Final:</span>
                        <span class="value">R$ {{ "{:,.2f}".format(seller.comissaoFinal) }}</span>
                    </div>
                </div>
            </div>

            <!-- Produtos com Comiss√£o Especial Detalhados -->
            {% if seller.details.produtos_detalhados %}
            <div class="product-section">
                <h3>üéØ PRODUTOS COM COMISS√ÉO ESPECIAL</h3>
                {% for produto in seller.details.produtos_detalhados %}
                <div class="product-detail-item">
                    <div class="product-header">
                        <h4>{{ produto.nome_produto }} ({{ "{:.1%}".format(produto.taxa_comissao) }})</h4>
                    </div>
                    <div class="product-summary">
                        <div class="product-item">
                            <span class="label">Faturamento:</span>
                            <span class="value">R$ {{ "{:,.2f}".format(produto.faturamento_total) }}</span>
                        </div>
                        <div class="product-item">
                            <span class="label">Comiss√£o:</span>
                            <span class="value">R$ {{ "{:,.2f}".format(produto.comissao_total) }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Outros Produtos -->
            {% if seller.details.outros_produtos.revenue > 0 %}
            <div class="product-section">
                <h3>üì¶ OUTROS PRODUTOS</h3>
                <div class="product-summary">
                    <div class="product-item">
                        <span class="label">Faturamento:</span>
                        <span class="value">R$ {{ "{:,.2f}".format(seller.details.outros_produtos.revenue) }}</span>
                    </div>
                    <div class="product-item">
                        <span class="label">Comiss√£o:</span>
                        <span class="value">R$ {{ "{:,.2f}".format(seller.details.outros_produtos.commission) }}</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Se√ß√£o de Totais e Ajustes Financeiros -->
            <div class="totals-section">
                <h3>üí∞ TOTAIS E AJUSTES FINANCEIROS</h3>
                <div class="totals-summary">
                    <div class="total-item">
                        <span class="label">Comiss√£o (vendas Oracle):</span>
                        <span class="value">R$ {{ "{:,.2f}".format(seller.comissaoBaseOracle) }}</span>
                    </div>
                    {% if seller.comissaoDoAjuste != 0 %}
                    <div class="total-item">
                        <span class="label">Comiss√£o (ajuste manual):</span>
                        <span class="value">R$ {{ "{:,.2f}".format(seller.comissaoDoAjuste) }}</span>
                    </div>
                    {% endif %}
                    <div class="total-item">
                        <span class="label">Comiss√£o Base Total:</span>
                        <span class="value">R$ {{ "{:,.2f}".format(seller.totalCommission) }}</span>
                    </div>
                    <div class="total-item">
                        <span class="label">Valor Acr√©sc. T√≠tulo Pago M√™s Ant.:</span>
                        <span class="value positive">+ R$ {{ "{:,.2f}".format(seller.ajustesFinanceiros.valorAcrescTituloPagoMesAnt) }}</span>
                    </div>
                    <div class="total-item">
                        <span class="label">Valor Ret. Merc. (Devolu√ß√£o):</span>
                        <span class="value negative">- R$ {{ "{:,.2f}".format(seller.ajustesFinanceiros.valorRetMerc) }}</span>
                    </div>
                    <div class="total-item">
                        <span class="label">Valor T√≠tulo Aberto:</span>
                        <span class="value negative">- R$ {{ "{:,.2f}".format(seller.ajustesFinanceiros.valorTituloAberto) }}</span>
                    </div>
                    <div class="total-item final">
                        <span class="label">Comiss√£o Final:</span>
                        <span class="value final-value">R$ {{ "{:,.2f}".format(seller.comissaoFinal) }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">üìä</div>
            <h2>Nenhum dado encontrado</h2>
            <p>{{ message }}</p>
            <a href="/" class="btn btn-primary">Voltar ao Dashboard</a>
        </div>
    {% endif %}

    <div class="actions">
        <a href="/" class="btn btn-secondary">Voltar</a>
    </div>
</div>

<!-- Modal de Ajustes Financeiros -->
<div id="modalAjuste" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Ajustes Financeiros</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <form id="formAjuste">
                <div class="form-group">
                    <label for="valorTituloAberto">Valor T√≠tulo em Aberto:</label>
                    <input type="number" id="valorTituloAberto" name="valorTituloAberto" step="0.01" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="valorRetMerc">Valor Ret. Merc. (Devolu√ß√£o):</label>
                    <input type="number" id="valorRetMerc" name="valorRetMerc" step="0.01" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="valorAcrescTituloPagoMesAnt">Valor Acr√©sc. T√≠tulo Pago M√™s Ant.:</label>
                    <input type="number" id="valorAcrescTituloPagoMesAnt" name="valorAcrescTituloPagoMesAnt" step="0.01" class="form-control" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Salvar Ajustes</button>
                    <button type="button" class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Ajuste de Faturamento -->
<div id="modalAjusteFaturamento" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalFaturamentoTitle">Ajuste de Faturamento</h3>
            <span class="close" onclick="fecharModalFaturamento()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="formAjusteFaturamento">
                <div class="form-group">
                    <label for="valorAjuste">Valor do Ajuste (R$):</label>
                    <input type="number" id="valorAjuste" name="valorAjuste" step="0.01" class="form-control" required>
                    <small class="form-text text-muted">Use valores positivos para adicionar ou negativos para subtrair</small>
                </div>
                <div class="form-group">
                    <label for="taxaComissaoAjuste">Taxa de Comiss√£o do Ajuste (%):</label>
                    <input type="number" id="taxaComissaoAjuste" name="taxaComissaoAjuste" step="0.001" min="0" max="100" class="form-control" required>
                    <small class="form-text text-muted">Ex: 0.5 para 0,5%, 1.0 para 1%</small>
                </div>
                <div class="form-group">
                    <label for="motivoAjuste">Motivo do Ajuste:</label>
                    <textarea id="motivoAjuste" name="motivoAjuste" class="form-control" rows="3" placeholder="Descreva o motivo deste ajuste..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Salvar Ajuste</button>
                    <button type="button" class="btn btn-secondary" onclick="fecharModalFaturamento()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Vari√°veis globais para o modal
let currentRca = null;
let currentMes = null;
let currentAno = null;

// Adicionar event listeners aos bot√µes de ajuste
document.addEventListener('DOMContentLoaded', function() {
    const ajusteBtns = document.querySelectorAll('.ajuste-btn');
    ajusteBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const rca = this.getAttribute('data-rca');
            const nome = this.getAttribute('data-nome');
            const mes = this.getAttribute('data-mes');
            const ano = this.getAttribute('data-ano');
            abrirModalAjuste(rca, nome, mes, ano);
        });
    });
    
    const ajusteFaturamentoBtns = document.querySelectorAll('.ajuste-faturamento-btn');
    ajusteFaturamentoBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const rca = this.getAttribute('data-rca');
            const nome = this.getAttribute('data-nome');
            const mes = this.getAttribute('data-mes');
            const ano = this.getAttribute('data-ano');
            abrirModalAjusteFaturamento(rca, nome, mes, ano);
        });
    });
});

function abrirModalAjuste(rca, nome, mes, ano) {
    currentRca = rca;
    currentMes = mes;
    currentAno = ano;
    
    // Atualizar t√≠tulo do modal
    document.getElementById('modalTitle').textContent = `Ajustes Financeiros para ${nome} - ${mes}/${ano}`;
    
    // Buscar dados existentes
    fetch(`/api/ajuste-financeiro/${rca}/${ano}/${mes}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('valorTituloAberto').value = data.ajuste.valor_titulo_aberto;
                document.getElementById('valorRetMerc').value = data.ajuste.valor_ret_merc;
                document.getElementById('valorAcrescTituloPagoMesAnt').value = data.ajuste.valor_acresc_titulo_pago_mes_ant;
            }
        })
        .catch(error => {
            console.error('Erro ao buscar ajustes:', error);
            // Limpar campos em caso de erro
            document.getElementById('valorTituloAberto').value = 0;
            document.getElementById('valorRetMerc').value = 0;
            document.getElementById('valorAcrescTituloPagoMesAnt').value = 0;
        });
    
    // Mostrar modal
    document.getElementById('modalAjuste').style.display = 'block';
}

function fecharModal() {
    document.getElementById('modalAjuste').style.display = 'none';
}

function fecharModalFaturamento() {
    document.getElementById('modalAjusteFaturamento').style.display = 'none';
}

// Fechar modal ao clicar no X
document.querySelector('.close').addEventListener('click', fecharModal);

// Fechar modal ao clicar fora dele
window.addEventListener('click', function(event) {
    const modal = document.getElementById('modalAjuste');
    const modalFaturamento = document.getElementById('modalAjusteFaturamento');
    if (event.target === modal) {
        fecharModal();
    }
    if (event.target === modalFaturamento) {
        fecharModalFaturamento();
    }
});

function abrirModalAjusteFaturamento(rca, nome, mes, ano) {
    currentRca = rca;
    currentMes = mes;
    currentAno = ano;
    
    // Atualizar t√≠tulo do modal
    document.getElementById('modalFaturamentoTitle').textContent = `Ajuste de Faturamento para ${nome} - ${mes}/${ano}`;
    
    // Buscar dados existentes
    fetch(`/api/ajuste-faturamento/${rca}/${ano}/${mes}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('valorAjuste').value = data.ajuste.valor_ajuste;
                document.getElementById('taxaComissaoAjuste').value = data.ajuste.taxa_comissao_ajuste;
                document.getElementById('motivoAjuste').value = data.ajuste.motivo || '';
            }
        })
        .catch(error => {
            console.error('Erro ao buscar ajuste de faturamento:', error);
            // Limpar campos em caso de erro
            document.getElementById('valorAjuste').value = 0;
            document.getElementById('taxaComissaoAjuste').value = 0;
            document.getElementById('motivoAjuste').value = '';
        });
    
    // Mostrar modal
    document.getElementById('modalAjusteFaturamento').style.display = 'block';
}

// Submiss√£o do formul√°rio
document.getElementById('formAjuste').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        vendedor_rca: parseInt(currentRca),
        mes: parseInt(currentMes),
        ano: parseInt(currentAno),
        valor_titulo_aberto: parseFloat(document.getElementById('valorTituloAberto').value),
        valor_ret_merc: parseFloat(document.getElementById('valorRetMerc').value),
        valor_acresc_titulo_pago_mes_ant: parseFloat(document.getElementById('valorAcrescTituloPagoMesAnt').value)
    };
    
    fetch('/api/ajuste-financeiro', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Ajustes salvos com sucesso!');
            fecharModal();
            // Recarregar a p√°gina para atualizar os valores
            window.location.reload();
        } else {
            alert('Erro ao salvar ajustes: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro ao salvar ajustes:', error);
        alert('Erro ao salvar ajustes. Tente novamente.');
            });
    });

// Submiss√£o do formul√°rio de ajuste de faturamento
document.getElementById('formAjusteFaturamento').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        vendedor_rca: parseInt(currentRca),
        mes: parseInt(currentMes),
        ano: parseInt(currentAno),
        valor_ajuste: parseFloat(document.getElementById('valorAjuste').value),
        taxa_comissao_ajuste: parseFloat(document.getElementById('taxaComissaoAjuste').value) / 100, // Converter % para decimal
        motivo: document.getElementById('motivoAjuste').value
    };
    
    fetch('/api/ajuste-faturamento', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Ajuste de faturamento salvo com sucesso!');
            fecharModalFaturamento();
            // Recarregar a p√°gina para atualizar os valores
            window.location.reload();
        } else {
            alert('Erro ao salvar ajuste de faturamento: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro ao salvar ajuste de faturamento:', error);
        alert('Erro ao salvar ajuste de faturamento. Tente novamente.');
    });
});
</script>
{% endblock %}
